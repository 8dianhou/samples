<!--
 *  Copyright (c) 2014 The WebRTC project authors. All Rights Reserved.
 *
 *  Use of this source code is governed by a BSD-style license
 *  that can be found in the LICENSE file in the root of the source
 *  tree.
-->

<!--
`user-media-permission` asks the user permission to access the media devices
such as camera and microphone and provides the permission result as an attribute
that can be used to style. Additionally it provides CSS-classes that can be
used in its content to control visibility. (.gum-allowed, .gum-denied).

Permission states are allowed/denied/unknown.

E.g.:

<user-media-permission audio video>
  Record a media message to your future self!
  <p class="gum-allowed">Recording...</p>
  <p class="gum-denied">Can't record a message with no permission.</p>
</user-media-permission>

-->
<link rel="import" href="../../bower_components/core-selector/core-selector.html">
<polymer-element name="user-media-permission" permission="unknown">
  <template>
    <style>
      :host([permission=allowed]) ::content > * .gum-denied,
      :host([permission=allowed]) ::content > * .gum-unknown,
      :host([permission=allowed]) ::content > * .gum-pending,
      :host([permission=denied]) ::content > * .gum-allowed,
      :host([permission=denied]) ::content > * .gum-unknown,
      :host([permission=unknown]) ::content > * .gum-allowed,
      :host([permission=unknown]) ::content > * .gum-denied {
        visibility: hidden;
      }
    </style>
    <content></content>
  </template>
  <script>
  (function () {
    Polymer({
      publish: {
        permission: {
          reflect: true
        },
      },

      created: function () {
        this.tryGetUserMedia(0);
      },

      tryGetUserMedia: function(timeout) {
        setTimeout(
            doGetUserMedia.bind(
              null,
              {audio: true, video: true},
              this.getUserMediaSuccess.bind(this),
              this.getUserMediaFail.bind(this)),
        timeout);
      },

      getUserMediaSuccess: function () {
        this.setAttribute('permission', 'allowed');
      },

      getUserMediaFail: function () {
        this.setAttribute('permission', 'denied');
        this.tryGetUserMedia(1000);
      }
    });
  }());
  </script>
</polymer-element>
